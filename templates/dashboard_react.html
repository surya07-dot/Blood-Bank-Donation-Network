{% extends "base.html" %}
{% block title %}Dashboard | BloodCare{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">
        <i class="bi bi-speedometer2"></i> Live Dashboard
    </h3>
    <div>
        <span class="badge bg-success">
            <i class="bi bi-wifi"></i> Live Updates Enabled
        </span>
    </div>
</div>

<!-- React Dashboard Components Container -->
<div id="react-dashboard-root"></div>

<!-- Load Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">

<!-- Load React Dashboard Components -->
<script type="text/babel" src="{{ url_for('static', filename='js/dashboard-components.jsx') }}"></script>

<script type="text/babel">
    // Initialize React Dashboard App
    const root = ReactDOM.createRoot(document.getElementById('react-dashboard-root'));
    root.render(<DashboardApp />);
</script>

<!-- Fallback: Show traditional view if user has existing data -->
<div class="mt-5 pt-5">
    <hr />
    <h5 class="text-muted mb-3">
        <i class="bi bi-list-ul"></i> Legacy View (Server-Rendered)
    </h5>
    
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0">Recent Donors (Static)</h6>
                </div>
                <div class="card-body">
                    {% if donors %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Blood Group</th>
                                        <th>City</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for d in donors %}
                                    <tr>
                                        <td>{{ d.full_name }}</td>
                                        <td><span class="badge bg-danger">{{ d.blood_group }}</span></td>
                                        <td>{{ d.city }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted small">No donors registered yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0">Blood Inventory (Static)</h6>
                </div>
                <div class="card-body">
                    {% if stock %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Blood Group</th>
                                        <th>Units Available</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for s in stock %}
                                    <tr>
                                        <td><span class="badge bg-danger">{{ s.blood_group }}</span></td>
                                        <td>{{ s.units_available }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted small">No stock data available.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    {% if current_user.is_admin %}
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-shield-check"></i> Admin Actions - Manage Requests
                    </h6>
                </div>
                <div class="card-body">
                    {% if recent_requests %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Hospital</th>
                                        <th>Blood</th>
                                        <th>Units</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in recent_requests %}
                                    <tr>
                                        <td>{{ r.patient_name }}</td>
                                        <td>{{ r.hospital_name }}</td>
                                        <td><span class="badge bg-danger">{{ r.blood_group }}</span></td>
                                        <td>{{ r.units }}</td>
                                        <td>
                                            {% if r.status == 'Pending' %}
                                                <span class="badge bg-warning">{{ r.status }}</span>
                                            {% elif r.status == 'Approved' %}
                                                <span class="badge bg-success">{{ r.status }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ r.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if r.status == 'Pending' %}
                                                <a href="{{ url_for('manage_request', request_id=r.id, action='approve') }}"
                                                   class="btn btn-sm btn-success"
                                                   onclick="return confirm('Approve this request?')">
                                                    <i class="bi bi-check-circle"></i> Approve
                                                </a>
                                                <a href="{{ url_for('manage_request', request_id=r.id, action='reject') }}"
                                                   class="btn btn-sm btn-danger"
                                                   onclick="return confirm('Reject this request?')">
                                                    <i class="bi bi-x-circle"></i> Reject
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No requests yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}
